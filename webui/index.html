<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kagami Supervisor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css" />
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script defer src="./app.js"></script>
</head>
<body>
  <div id="app" class="page">
    <header class="hero">
      <div>
        <div class="eyebrow">Kagami Supervisor</div>
        <h1>Control Room</h1>
        <p class="lead">Actor-model distributed mirrors with live orchestration across workers.</p>
        <div class="hero-meta">
          <span class="pill accent">API {{ apiBase }}</span>
          <span class="pill muted" v-if="lastUpdated">Updated {{ formatRelative(lastUpdated) }}</span>
        </div>
      </div>
      <div class="hero-actions">
        <button class="btn ghost" @click="refreshAll" :disabled="isBusy">Refresh Data</button>
        <div class="caption" v-if="isBusy">Updating…</div>
      </div>

      <nav class="page-nav">
        <button
          v-for="page in pages"
          :key="page.key"
          type="button"
          class="nav-link"
          :class="{ active: activePage === page.key }"
          @click="setPage(page.key)"
        >
          {{ page.label }}
        </button>
      </nav>
    </header>

    <div v-if="banner" class="banner">
      <div>{{ banner }}</div>
      <button class="btn ghost" @click="refreshAll">Retry</button>

      <template v-if="activePage === 'overview'">
        <section class="stat-grid">
          <article class="stat-card">
            <div class="label muted">Workers</div>
            <div class="stat-value">{{ overview.workers_total }}</div>
            <div class="stat-meta">
              <span class="pill good">Approved {{ overview.workers_approved }}</span>
              <span class="pill warn">Pending {{ overview.workers_pending }}</span>
              <span class="pill bad">Rejected {{ overview.workers_rejected || 0 }}</span>
            </div>
          </article>
          <article class="stat-card">
            <div class="label muted">Resources</div>
            <div class="stat-value">{{ overview.resources_total }}</div>
            <p class="muted">Tracked replicas across the fleet.</p>
          </article>
          <article class="stat-card">
            <div class="label muted">Heartbeat</div>
            <div class="stat-value mono small">{{ lastUpdated ? formatAbsolute(lastUpdated) : '—' }}</div>
            <p class="muted">Last data refresh</p>
          </article>
        </section>

        <section class="panel telemetry-panel">
          <div class="panel-head">
            <div>
              <p class="eyebrow muted">Telemetry</p>
              <h3>Live operations</h3>
              <p class="muted">Fleet-wide throughput, storage, and sync health.</p>
            </div>
            <div class="panel-actions">
              <span class="pill muted" v-if="telemetry.last_sample_at">Sampled {{ formatRelative(telemetry.last_sample_at) }}</span>
              <button class="btn ghost" @click="loadTelemetry" :disabled="loading.telemetry">Refresh telemetry</button>
            </div>
          </div>
          <div class="muted loading-row" v-if="loading.telemetry">Collecting telemetry…</div>
          <div class="telemetry-grid" v-else>
            <article class="telemetry-card span-2 traffic-card">
              <div class="card-head">
                <div>
                  <p class="eyebrow muted">Traffic</p>
                  <h3>Event throughput</h3>
                </div>
                <span class="pill" :class="trafficTrend >= 0 ? 'good' : 'bad'">
                  {{ trafficTrend >= 0 ? '+' : '' }}{{ trafficTrend.toFixed(1) }}%
                </span>
              </div>
              <div class="stat-value">
                {{ formatNumber(trafficCurrent) }}
                <span class="stat-suffix">msgs/min</span>
              </div>
              <p class="muted">Avg {{ formatNumber(Math.round(trafficAverage)) }} msgs/min</p>
              <div class="sparkline">
                <svg viewBox="0 0 420 140" preserveAspectRatio="none">
                  <path class="sparkline-area" :d="trafficAreaPath"></path>
                  <path class="sparkline-line" :d="trafficLinePath"></path>
                </svg>
              </div>
            </article>

            <article class="telemetry-card">
              <div class="card-head">
                <div>
                  <p class="eyebrow muted">Sync health</p>
                  <h3>Replica success</h3>
                </div>
                <span class="pill good">{{ syncTotals.rate.toFixed(1) }}%</span>
              </div>
              <div class="split">
                <div>
                  <div class="label muted">Success</div>
                  <div class="stat-value small">{{ formatNumber(syncTotals.success) }}</div>
                </div>
                <div>
                  <div class="label muted">Failure</div>
                  <div class="stat-value small">{{ formatNumber(syncTotals.failure) }}</div>
                </div>
              </div>
              <div class="sync-meter">
                <div class="sync-bar good" :style="{ width: syncTotals.rate + '%' }"></div>
                <div class="sync-bar bad" :style="{ width: syncTotals.failureRate + '%' }"></div>
              </div>
            </article>

            <article class="telemetry-card disk-card">
              <div class="card-head">
                <div>
                  <p class="eyebrow muted">Storage</p>
                  <h3>Capacity headroom</h3>
                </div>
                <span class="pill muted">{{ formatNumber(diskStats.total) }} GB total</span>
              </div>
              <div class="disk-ring" :style="diskRingStyle">
                <div class="disk-ring-core">
                  <div class="disk-ring-value">{{ diskStats.remainingPercent.toFixed(0) }}%</div>
                  <div class="caption">Free</div>
                </div>
              </div>
              <p class="muted">Used {{ formatNumber(diskStats.used) }} GB · Remaining {{ formatNumber(diskStats.remaining) }} GB</p>
            </article>

            <article class="telemetry-card metrics-card">
              <div class="card-head">
                <div>
                  <p class="eyebrow muted">Runtime</p>
                  <h3>Live metrics</h3>
                </div>
              </div>
              <div class="metric-list">
                <div class="metric-item">
                  <div class="label muted">Message rate</div>
                  <div class="stat-value small">{{ formatNumber(telemetry.message_rate) }}</div>
                  <div class="caption">per minute</div>
                </div>
                <div class="metric-item">
                  <div class="label muted">Concurrent jobs</div>
                  <div class="stat-value small">{{ formatNumber(telemetry.concurrent_jobs) }}</div>
                  <div class="caption">workers syncing</div>
                </div>
              </div>
              <div class="latency-grid">
                <span class="pill tiny">p50 {{ telemetry.latency_ms.p50.toFixed(0) }} ms</span>
                <span class="pill tiny warn">p95 {{ telemetry.latency_ms.p95.toFixed(0) }} ms</span>
                <span class="pill tiny bad">p99 {{ telemetry.latency_ms.p99.toFixed(0) }} ms</span>
              </div>
            </article>
          </div>
        </section>
      </template>

      <template v-if="activePage === 'workers'">
        <section class="panel">
        <div>
          <p class="eyebrow muted">Workers</p>
          <h3>Fleet status</h3>
          <p class="muted">Approve, terminate, and manage replicas per worker.</p>
        </div>
        <button class="btn primary" @click="refreshAll">Sync view</button>
      </div>
      <div class="muted" v-if="loading.workers">Loading workers...</div>
      <div class="table-shell" v-else>
        <table class="data-table">
          <thead>
            <tr><th>Worker</th><th>Approval</th><th>Last Seen</th><th>Replicas</th><th>Actions</th></tr>
          </thead>
          <tbody>
            <tr v-for="w in workers" :key="w.worker_id">
              <td>
                <div class="title">{{ w.worker_id }}</div>
                <div class="muted mono">Replicas: {{ w.replicas.length }}</div>
              </td>
              <td>
                <span class="pill" :class="statusClass(workerStatus(w))">{{ workerStatus(w) }}</span>
              </td>
              <td>
                <div>{{ formatRelative(w.last_seen) }}</div>
                <div class="muted mono">{{ formatAbsolute(w.last_seen) }}</div>
              </td>
              <td>
                <div class="replica-list">
                  <div class="replica">
                    <div class="replica-head">
                      <div>
                        <div class="title">Replicas</div>
                        <div class="muted mono">{{ w.replicas.length }} attached</div>
                      </div>
                      <button class="btn ghost" @click="openWorker(w)">View details</button>
                    </div>
                  </div>
                </div>
              </td>
              <td class="action-col">
                <div class="action-stack">
                  <button v-if="workerStatus(w) === 'pending'" class="btn primary" @click="approve(w.worker_id)">Approve</button>
                  <button v-if="workerStatus(w) === 'pending'" class="btn danger ghost" @click="reject(w.worker_id)">Reject</button>
                  <button v-if="workerStatus(w) === 'approved'" class="btn danger ghost" @click="terminate(w.worker_id)">Terminate</button>
                  <span v-if="workerStatus(w) === 'rejected'" class="muted">Rejected</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

      <div class="modal" v-if="activePage === 'workers' && activeWorker">
      <div class="modal-card">
        <div class="modal-head">
          <div>
            <p class="eyebrow">Worker details</p>
            <h3>{{ activeWorker.worker_id }}</h3>
            <div class="chip-row">
              <span class="pill" :class="statusClass(workerStatus(activeWorker))">{{ workerStatus(activeWorker) }}</span>
              <span class="pill tiny muted">Replicas {{ activeWorker.replicas.length }}</span>
            </div>
          </div>
          <button class="btn ghost" @click="closeWorker">Close</button>
        </div>
        <div v-if="modalNotice.message" class="toast" :class="modalNotice.kind === 'danger' ? 'danger' : ''">
          {{ modalNotice.message }}
        </div>

  <div class="replica-list modal-replica-list">
          <div class="replica" v-for="r in activeWorker.replicas" :key="r.replica_id">
            <div class="replica-head">
              <div>
                <div class="title">{{ r.name }}</div>
                <div class="muted mono">{{ r.kind }} · {{ r.replica_id }}</div>
                <div class="muted">Upstream: {{ r.upstream }} <span v-if="r.interval_secs" class="pill tiny muted">every {{ r.interval_secs }}s</span></div>
              </div>
              <span class="pill tiny" :class="statusClass(r.status)">{{ r.status || 'unknown' }}</span>
            </div>
            <div class="replica-actions">
              <button
                class="btn ghost"
                :disabled="workerStatus(activeWorker) !== 'approved'"
                title="Approve worker to enable sync"
                @click="syncReplica(activeWorker.worker_id, r.name)"
              >Sync</button>
              <button
                class="btn danger ghost"
                :disabled="workerStatus(activeWorker) !== 'approved'"
                title="Approve worker to enable remove"
                @click="removeReplica(activeWorker.worker_id, r.replica_id)"
              >Remove</button>
            </div>
          </div>
          <div class="replica" v-if="workerStatus(activeWorker) === 'approved'">
            <div class="title replica-add-title">Add replica</div>
            <div class="form-grid">
              <label class="form-field">
                <span class="muted">Name</span>
                <input placeholder="repo-mirror" v-model="newReplica.name" />
              </label>
              <label class="form-field">
                <span class="muted">Protocol</span>
                <select v-model="newReplica.kind">
                  <option value="git">git</option>
                  <option value="rsync">rsync</option>
                  <option value="http">http</option>
                </select>
              </label>
              <label class="form-field">
                <span class="muted">Interval (seconds, 0=manual)</span>
                <input type="number" min="0" v-model.number="newReplica.interval_secs" />
              </label>
            </div>
            <label class="form-field full">
              <span class="muted">Upstream URL</span>
              <input placeholder="https://example.com/repo.git" v-model="newReplica.upstream" />
            </label>
            <label class="form-field full">
              <span class="muted">Labels (key=value, comma separated)</span>
              <input placeholder="env=prod,region=us" v-model="newReplica.labels_text" />
            </label>
            <div class="form-actions">
              <button class="btn ghost" @click="closeWorker">Cancel</button>
              <button class="btn primary" @click="addReplica">Add Replica</button>
            </div>
          </div>
        </div>
      </div>
    </template>

    <template v-if="activePage === 'mirrors'">
      <section class="panel">
        <div class="panel-head">
          <div>
            <p class="eyebrow muted">Resources</p>
            <h3>Mirror coverage</h3>
            <p class="muted">Status per resource and replicas across workers.</p>
          </div>
        </div>
        <div class="muted" v-if="loading.resources">Loading resources...</div>
        <div class="table-shell" v-else>
          <table class="data-table">
            <thead><tr><th>Name</th><th>Status</th><th>Replicas</th></tr></thead>
            <tbody>
              <tr v-for="r in resources" :key="r.name">
                <td class="title">{{ r.name }}</td>
                <td><span class="pill" :class="statusClass(r.status)">{{ r.status }}</span></td>
                <td>
                  <div class="replica-list compact">
                    <div class="replica-line" v-for="rep in r.replicas" :key="rep.replica_id">
                      <span class="pill tiny muted">{{ rep.worker_id }}</span>
                      <span class="muted mono">{{ rep.replica_id }}</span>
                      <span class="pill tiny" :class="statusClass(rep.status)">{{ rep.status }}</span>
                    </div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </template>
  </div>
</body>
</html>
